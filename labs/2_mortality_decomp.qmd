---
title: "Week 2: Mortality I"
subtitle: "SOC6708 ADA"
author: "Monica Alexander"
format: pdf
execute: 
  warning: false
  message: false
---

# Read in data

```{r}
library(tidyverse)
library(here)
library(readxl)
library(janitor)
```

For this example we are using mortality in Canada by cause, 2012-2016. Available from [StatCan](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1310039201). 

```{r}
d <- read_csv(here("data", "CAN_age_cod.csv"))
head(d)
```


# Create a life table

Let's create a life table using the mortality rates from all causes of death in 2016. Get the data we need:

```{r}
dl <- d %>% 
  filter(year==2016, cause=="Total, all causes of death  [A00-Y89]") %>% 
  mutate(age = start_age, Mx = rate/100000) %>% 
  select(age, Mx)

head(dl)
```

We need to create columns:

- $n$
- $_na_x$
- $_nq_x$
- $_nd_x$
- $_nL_x$
- $T_x$
- $e_x$

```{r}
d_lt <- dl |> 
     mutate(n = case_when(
       age==0 ~ 1,
       age==1 ~ 4,
       TRUE ~ 5
     ),
       ax = case_when(
       age==0 ~ 0.07 + 1.7*Mx,
       age==1 ~ 1.5,
       age==90 ~ 1/Mx,
       TRUE ~ 2.5
     ),
      qx = n * Mx / (1 + (n - ax)* Mx),
      px = 1 - qx,
      lx = lag(cumprod(px), default = 1),
      dx = lx - lead(lx, default = 0),
      Lx = n * lead(lx, default = 0) + (ax* dx),
      Tx = rev(cumsum(rev(Lx))),
      ex = Tx / lx
      ) 
```

What's the life expectancy at age 10?

## Exercise

Calculate the lifespan disparity for Canada in 2016.

# Calculate cause-deleted life expectancy

Now calculate life expectancy if all intentional injuries were deleted. Get the data we need:

```{r}
dls <- d %>% 
  filter(year==2016, cause=="Total, all causes of death  [A00-Y89]"|cause=="Intentional self-harm (suicide)  [X60-X84, Y87.0]") %>% 
  mutate(age = start_age, Mx = rate/100000) %>% 
  select(age, cause, Mx) %>% 
  mutate(cause = ifelse(cause=="Intentional self-harm (suicide)  [X60-X84, Y87.0]", "suicide", "total")) %>% 
  spread(cause, Mx) %>% 
  rename(Mx_i = suicide,
         Mx = total)

head(dls)
```

## Exercise: Cause-deleted life expectancy

You need to create the same columns as above, but with the cause-deleted versions ($-i$). Do this by first creating the ratio $R_x^{-i} = \frac{M_x^{-i}}{M_x}$, use this to get $_nq_x^{-i}$, and the rest is the same. 

What's the cause-deleted life expectancy at age 10? What's the implied life lost due to suicide?


# Decomposition

Let's read in WPP data from last week and calculate the age-specific mortality rates:

```{r}
d_male <- read_xlsx(here("data/WPP2024_POP_F01_2_POPULATION_SINGLE_AGE_MALE.xlsx"), skip = 16)
d_male$sex <- "Male"
d_male <- d_male |> drop_na(Year)
d_female <- read_xlsx(here("data/WPP2024_POP_F01_3_POPULATION_SINGLE_AGE_FEMALE.xlsx"), skip = 16)
d_female$sex <- "Female"
d_female <- d_female |> drop_na(Year)

d <- rbind(d_male, d_female)
rm(d_male, d_female)

d <- d  |> 
  clean_names() |> 
  select(region_subregion_country_or_area, iso3_alpha_code, year, x0:sex) |> 
  rename(region = region_subregion_country_or_area) |> 
  mutate(across(x0:x100, as.numeric))

d_male <- read_xlsx(here("data/WPP2024_MORT_F01_2_DEATHS_SINGLE_AGE_MALE.xlsx"), skip = 16)
d_male$sex <- "Male"
d_male <- d_male |> drop_na(Year)
d_female <- read_xlsx(here("data/WPP2024_MORT_F01_3_DEATHS_SINGLE_AGE_FEMALE.xlsx"), skip = 16)
d_female$sex <- "Female"
d_female <- d_female |> drop_na(Year)

dm <- rbind(d_male, d_female)
rm(d_male, d_female)

dm <- dm  |> 
  clean_names() |> 
  select(region_subregion_country_or_area, iso3_alpha_code, year, x0:sex) |> 
  rename(region = region_subregion_country_or_area) |> 
  mutate(across(x0:x100, as.numeric))

d_long <- d  |>  
  pivot_longer(x0:x100, names_to = "age", values_to = "pop") |> 
  mutate(age = as.numeric(str_remove(age, "x")))

dm_long <- dm  |>  
  pivot_longer(x0:x100, names_to = "age", values_to = "deaths") |> 
  mutate(age = as.numeric(str_remove(age, "x")))

# join these two tibbles and calculate rates

asmr <- d_long |> 
  left_join(dm_long) |> 
  mutate(mx = deaths/pop)

```

Do the decomposition of the difference between Kenya and Canada:

```{r}
asmr |> 
  filter(region == "Kenya",year==2023)  |> 
  select(sex, age, pop, mx) |> 
  rename(pop_kenya = pop, mx_kenya = mx) |> 
  left_join(asmr |> 
              filter(region == "Canada",year==2023)  |> 
              select(sex, age, pop, mx) |> 
              rename(pop_can = pop, mx_can = mx) ) |> 
  mutate(prop_kenya = pop_kenya/sum(pop_kenya),
         prop_can = pop_can/sum(pop_can)) |> 
  mutate(rate_diff = mx_kenya - mx_can,
         prop_diff = prop_kenya - prop_can) |> 
  mutate(ave_rate = (mx_kenya+mx_can)/2,
         ave_prop = (prop_kenya+prop_can)/2) |> 
  mutate(age_contr = prop_diff*ave_rate,
         rate_contr = rate_diff*ave_prop) |> 
  summarize(age_total_contr = sum(age_contr),
            rate_total_contr = sum(rate_contr)) |> 
  mutate(total_diff = age_total_contr+rate_total_contr)
```

Check that the difference is actually the difference between the two CDRs

```{r}
asmr |> 
  filter(region == "Kenya"|region=="Canada",year==2023) |> 
  group_by(region) |> 
  summarize(cdr = sum(mx*pop)/sum(pop)) |> 
  summarise(diff = cdr[region=="Kenya"] - cdr[region=="Canada"])
```

## Exercise

Decompose the difference in CDRs between USA and Japan in the year 2023. Is the majority of the difference due to age structure or mortality?

